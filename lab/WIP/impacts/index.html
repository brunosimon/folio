<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Impact</title>
    <style>
        html,body {margin:0;padding:0;background:#000;}
        canvas {display:block;}
    </style>
</head>
<body>
    <canvas id="three-canvas"></canvas>
    <script src="http://ajax.googleapis.com/ajax/libs/threejs/r67/three.min.js"></script>
    <script src="src/js/libs/three-js/OBJLoader.js"></script>
    <script src="src/js/libs/Wagner/Wagner.js"></script>
    <script>
        WAGNER.log = function(){};</script>
    <script src="src/js/libs/Wagner/Wagner.base.js"></script>
    <!-- <script src="src/js/libs/Wagner/Wagner.experimental.js"></script> -->
    <script src="src/js/libs/Wagner/ShaderLoader.js"></script>
    <script>

        /* SCENE */
        var scene  = new THREE.Scene(),
            camera = new THREE.PerspectiveCamera(85,window.innerWidth/window.innerHeight,0.0001,1000),
            center = new THREE.Vector3(0,0.2,0);

        camera.position.y = 0.2;
        camera.position.z = 0.5;

        /* WAGNER */
        WAGNER.vertexShadersPath   = 'src/js/libs/Wagner/vertex-shaders';
        WAGNER.fragmentShadersPath = 'src/js/libs/Wagner/fragment-shaders';
        WAGNER.assetsPath          = 'src/js/libs/Wagner/assets/';

        /* RENDER */
        var canvas    = document.getElementById('three-canvas'),
            renderer  = new THREE.WebGLRenderer({canvas:canvas,alpha:true}),
            composer  = new WAGNER.Composer( renderer, { useRGBA: false } ),
            bloomPass = new WAGNER.MultiPassBloomPass(),
            dirtPass  = new WAGNER.DirtPass();

        bloomPass.blendPass.params.opacity = 1;
        bloomPass.params.blurAmount        = 30;

        composer.setSize(window.innerWidth,window.innerHeight);

        renderer.setClearColor(0x000000,0);
        renderer.setSize(window.innerWidth,window.innerHeight);

        /* DUMMY */
        function init_dummy()
        {
            var material = new THREE.MeshNormalMaterial(),
                geometry = new THREE.BoxGeometry(1,1,1),
                mesh     = new THREE.Mesh(geometry,material);

            scene.add(mesh);
        }
        // init_dummy();

        /* DEMO */
        function init_demo()
        {
            // // Lights
            // var ambient_light = new THREE.AmbientLight(0xffffff);
            // scene.add(ambient_light);

            // Models
            var manager    = new THREE.LoadingManager(),
                loader     = new THREE.OBJLoader(manager),
                elements   = ['floor','wall_1','wall_2','object'],
                containers = new THREE.Object3D();

            // Each model
            for(var i = 0; i < elements.length; i++)
            {
                // Scope
                (function(element)
                {
                    var container = new THREE.Object3D(),
                        material  = new THREE.MeshLambertMaterial({
                            map : THREE.ImageUtils.loadTexture('export/' + element + '.jpg')
                        });

                    material.emissive = new THREE.Color(0xffffff);

                    // Rotate container
                    container.rotation.y = - Math.PI / 4;

                    loader.load('export/' + element + '.obj',function(object)
                    {
                        object.traverse(function(child)
                        {
                            if(child instanceof THREE.Mesh)
                            {
                                child.scale.set(0.02,0.02,0.02);
                                child.material = material;
                                child.geometry.needsUpdate = true;
                                container.add(child);
                            }
                        });
                    });

                    containers.add(container);
                })(elements[i]);
            }

            scene.add(containers);
        }
        init_demo();

        /* RESIZE */
        var win = {width:window.innerWidth,height:window.innerHeight};
        window.onresize = function()
        {
            win.width  = window.innerWidth;
            win.height = window.innerHeight;

            canvas.width  = win.width;
            canvas.height = win.height;
            camera.aspect = win.width / win.height;
            camera.updateProjectionMatrix();
            renderer.setSize(win.width,win.height);
        };

        /* MOUSE MOVE */
        var mouse = {x:0,y:0,ratio:{x:0,y:0}};
        window.onmousemove = function(e)
        {
            mouse.x = e.clientX;
            mouse.y = e.clientY;

            mouse.ratio.x = mouse.x / win.width;
            mouse.ratio.y = mouse.y / win.height;
        };

        /* MOUSE WHEEL */
        var distance = 2;
        var mouse_wheel_handler = function(e)
        {
            e.preventDefault();

            var delta = e.wheelDeltaY || e.wheelDelta || - e.detail;

            distance += - delta / 200;

            if(distance < 0.4)
                distance = 0.4;
            else if(distance > 4)
                distance = 4;

            return false;
        };
        document.addEventListener('mousewheel',mouse_wheel_handler,false);
        document.addEventListener('DOMMouseScroll',mouse_wheel_handler,false);

        /* FRAMES */
        function loop()
        {
            window.requestAnimationFrame(loop);

            camera.position.x += (Math.sin(mouse.ratio.x * 2 - 1) * distance - camera.position.x) / 10;
            camera.position.z += (Math.cos(mouse.ratio.x * 2 - 1) * distance - camera.position.z) / 10;
            camera.position.y += (- (mouse.ratio.y - 1) * distance - camera.position.y) / 10;
            camera.lookAt(center);

            // renderer.render(scene,camera);

            composer.reset();
            composer.render(scene,camera);

            composer.pass(bloomPass);
            // composer.pass( dirtPass );
            composer.toScreen();
        }

        loop();
    </script>
</body>
</html>
